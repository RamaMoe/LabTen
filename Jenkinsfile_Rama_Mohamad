pipeline {
    agent any

    stages {
        stage('Setup') {
            steps {
                bat """
                python -m venv venv
                venv\\Scripts\\pip.exe install --upgrade pip
                venv\\Scripts\\pip.exe install -r requirements.txt
                """
            }
        }

        stage('Lint') {
            steps {
                bat "venv\\Scripts\\python.exe -m flake8 app.py"
            }
        }

        stage('Test') {
            steps {
                bat "venv\\Scripts\\pytest.exe"
            }
        }

        stage('Coverage') {
            steps {
                bat """
                venv\\Scripts\\coverage.exe run -m pytest
                venv\\Scripts\\coverage.exe report
                """
            }
        }

        stage('Security Scan') {
            steps {
                bat "venv\\Scripts\\bandit.exe -r ."
            }
        }

        stage('Deploy') {
            steps {
                bat "venv\\Scripts\\python.exe app.py"
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
